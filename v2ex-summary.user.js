// ==UserScript==
// @name         V2EX ÊñáÁ´†ÊÄªÁªìÂä©Êâã
// @name:zh-CN   V2EX ÊñáÁ´†ÊÄªÁªìÂä©Êâã
// @namespace    http://tampermonkey.net/
// @version      1.0
// @description  ‰∏∫ V2EX Â∏ñÂ≠êÁîüÊàêÊÄªÁªì
// @description:zh-CN  ‰∏∫ V2EX Â∏ñÂ≠êÁîüÊàêÊÄªÁªì
// @author       Jandaes
// @homepage     https://greasyfork.org/zh-CN/scripts/521732-v2ex-%E6%96%87%E7%AB%A0%E6%80%BB%E7%BB%93%E5%8A%A9%E6%89%8B
// @supportURL   https://github.com/Jandaes/v2ex_ai
// @match        https://www.v2ex.com/*
// @icon         https://www.v2ex.com/favicon.ico
// @grant        none
// @license      MIT
// @copyright    2024, Jandaes (https://github.com/Jandaes)
// ==/UserScript==

(function() {
    'use strict';

    // Âú®ËÑöÊú¨ÂºÄÂ§¥Ê∑ªÂä† marked Â∫ì
    const markedScript = document.createElement('script');
    markedScript.src = 'https://cdn.jsdelivr.net/npm/marked/marked.min.js';
    document.head.appendChild(markedScript);

    function createSettingsModal() {
        // ‰ªélocalStorageËé∑ÂèñÁî®Êà∑ÁöÑ‰∏ªÈ¢òÂÅèÂ•ΩÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàô‰ΩøÁî®Á≥ªÁªüËÆæÁΩÆ
        const savedTheme = localStorage.getItem('v2exSummaryTheme');
        const systemDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const isDarkMode = savedTheme ? savedTheme === 'dark' : systemDarkMode;

        // ÂÆö‰πâÊ∑±Ëâ≤/ÊµÖËâ≤‰∏ªÈ¢òÁöÑÈ¢úËâ≤
        const getThemeColors = (dark) => ({
            background: dark ? '#2d2d2d' : 'white',
            text: dark ? '#e0e0e0' : '#333',
            inputBg: dark ? '#3d3d3d' : '#f5f5f5',
            inputBorder: dark ? '#4d4d4d' : '#ddd',
            buttonBg: dark ? '#4d4d4d' : '#e2e2e2',
            buttonHoverBg: dark ? '#5d5d5d' : '#d2d2d2',
            modalOverlay: 'rgba(0, 0, 0, 0.6)'
        });

        let theme = getThemeColors(isDarkMode);

        // ÂàõÂª∫Ê®°ÊÄÅÊ°ÜÂÆπÂô®
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: ${theme.modalOverlay};
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(3px);
        `;

        // ÂàõÂª∫Ê®°ÊÄÅÊ°ÜÂÜÖÂÆπ
        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
            position: relative;
            background: ${theme.background};
            padding: 25px;
            border-radius: 12px;
            width: 450px;
            max-width: 90%;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            color: ${theme.text};
            padding-bottom: 20px;
        `;

        // ÂàõÂª∫Ê†áÈ¢òÂíå‰∏ªÈ¢òÂàáÊç¢
        const titleContainer = document.createElement('div');
        titleContainer.style.cssText = `
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid ${theme.inputBorder};
        `;

        const title = document.createElement('h3');
        title.textContent = 'V2EX ÊñáÁ´†ÊÄªÁªìÂä©ÊâãËÆæÁΩÆ';
        title.style.cssText = `
            margin: 0;
            font-size: 18px;
            font-weight: 500;
        `;

        const themeToggle = document.createElement('div');
        themeToggle.style.cssText = `display: flex; align-items: center; gap: 8px;`;
        themeToggle.innerHTML = `
            <span style="font-size: 14px;">‰∏ªÈ¢ò</span>
            <select id="themeSelect" class="setting-input" style="width: auto; padding: 4px 8px;">
                <option value="system" ${!savedTheme ? 'selected' : ''}>Ë∑üÈöèÁ≥ªÁªü</option>
                <option value="light" ${savedTheme === 'light' ? 'selected' : ''}>ÊµÖËâ≤</option>
                <option value="dark" ${savedTheme === 'dark' ? 'selected' : ''}>Ê∑±Ëâ≤</option>
            </select>
        `;

        titleContainer.appendChild(title);
        titleContainer.appendChild(themeToggle);
        modalContent.appendChild(titleContainer);

        // ÂàõÂª∫Ë°®Âçï
        const form = document.createElement('form');
        form.innerHTML = `
            <style>
                .setting-group {
                    margin-bottom: 20px;
                    width: 90%;
                    margin-left: auto;
                    margin-right: auto;
                    display: flex;
                    align-items: center;
                    gap: 15px;
                }
                .setting-label {
                    width: 85px;
                    text-align: right;
                    flex-shrink: 0;
                    font-weight: 500;
                }
                .setting-input {
                    flex: 1;
                    padding: 8px 12px;
                    border: 1px solid ${theme.inputBorder};
                    border-radius: 6px;
                    background: ${theme.inputBg};
                    color: ${theme.text};
                    font-size: 14px;
                    transition: all 0.2s ease;
                }
                .setting-input:focus {
                    outline: none;
                    border-color: #0066cc;
                    box-shadow: 0 0 0 2px rgba(0,102,204,0.2);
                }
                .password-container {
                    position: relative;
                    flex: 1;
                    display: flex;
                }
                .password-container .setting-input {
                    width: 100%;
                }
                .password-toggle {
                    position: absolute;
                    right: 12px;
                    top: 50%;
                    transform: translateY(-50%);
                    cursor: pointer;
                    user-select: none;
                    color: ${theme.text};
                    opacity: 0.7;
                    font-size: 14px;
                }
                .password-toggle:hover {
                    opacity: 1;
                }
                .button-container {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-top: 25px;
                    padding: 0 5%;
                }
                .button-group {
                    display: flex;
                    gap: 10px;
                }
                .github-link {
                    display: flex;
                    align-items: center;
                    gap: 6px;
                    color: ${theme.text};
                    text-decoration: none;
                    opacity: 0.8;
                    transition: opacity 0.2s ease;
                    font-size: 14px;
                }
                .github-icon {
                    width: 16px;
                    height: 16px;
                }
                .modal-button {
                    padding: 8px 16px;
                    border: none;
                    border-radius: 6px;
                    background: ${theme.buttonBg};
                    color: ${theme.text};
                    cursor: pointer;
                    font-size: 14px;
                    transition: all 0.2s ease;
                }
                .modal-button:hover {
                    background: ${theme.buttonHoverBg};
                }
                .modal-button.primary {
                    background: #0066cc;
                    color: white;
                }
                .modal-button.primary:hover {
                    background: #0052a3;
                }
            </style>
            <div class="setting-group">
                <label class="setting-label">API URLÔºö</label>
                <input type="text" id="apiUrl" class="setting-input" placeholder="ËØ∑ËæìÂÖ• API Âú∞ÂùÄ">
            </div>
            <div class="setting-group">
                <label class="setting-label">API KeyÔºö</label>
                <div class="password-container">
                    <input type="password" id="apiKey" class="setting-input" placeholder="ËØ∑ËæìÂÖ• API Key">
                    <span class="password-toggle" id="togglePassword">üîí</span>
                </div>
            </div>
            <div class="setting-group">
                <label class="setting-label">Ê®°ÂûãÂêçÁß∞Ôºö</label>
                <input type="text" id="modelName" class="setting-input" placeholder="ËØ∑ËæìÂÖ•Ê®°ÂûãÂêçÁß∞">
            </div>
            <div class="setting-group">
                <label class="setting-label">Á≥ªÁªüÊèêÁ§∫ËØçÔºö</label>
                <textarea id="prompt" class="setting-input" style="height: 100px; resize: vertical;" 
                    placeholder="ËØ∑ËæìÂÖ•"></textarea>
            </div>
            <div class="button-container">
                <a href="https://github.com/Jandaes/v2ex_ai" target="_blank" class="github-link">
                    <svg class="github-icon" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                    </svg>
                    GitHub
                </a>
                <div class="button-group">
                    <button type="button" id="cancelBtn" class="modal-button">ÂèñÊ∂à</button>
                    <button type="button" id="saveBtn" class="modal-button primary">‰øùÂ≠ò</button>
                </div>
            </div>
        `;

        modalContent.appendChild(form);

        // Ê∑ªÂä†Ëøô‰∏ÄË°åÔºåÂ∞Ü modalContent Ê∑ªÂä†Âà∞ modal ‰∏≠
        modal.appendChild(modalContent);

        // ‰∏ªÈ¢òÂàáÊç¢ÂäüËÉΩ
        const updateTheme = (newTheme) => {
            theme = getThemeColors(newTheme === 'dark');
            // Êõ¥Êñ∞ÊâÄÊúâÁõ∏ÂÖ≥Ê†∑Âºè...
            modalContent.style.background = theme.background;
            modalContent.style.color = theme.text;
            // Êõ¥Êñ∞ÂÖ∂‰ªñÂÖÉÁ¥†Ê†∑Âºè...
        };

        const themeSelect = modal.querySelector('#themeSelect');
        themeSelect.addEventListener('change', (e) => {
            const selectedTheme = e.target.value;
            if (selectedTheme === 'system') {
                localStorage.removeItem('v2exSummaryTheme');
                updateTheme(systemDarkMode ? 'dark' : 'light');
            } else {
                localStorage.setItem('v2exSummaryTheme', selectedTheme);
                updateTheme(selectedTheme);
            }
        });

        // API Key ÊòæÁ§∫ÂàáÊç¢ÂäüËÉΩ
        const togglePassword = modal.querySelector('#togglePassword');
        const apiKeyInput = modal.querySelector('#apiKey');
        togglePassword.addEventListener('click', () => {
            const type = apiKeyInput.type === 'password' ? 'text' : 'password';
            apiKeyInput.type = type;
            togglePassword.textContent = type === 'password' ? 'üîí' : 'üîì';
        });

        // ‰øÆÊîπÈªòËÆ§ÊèêÁ§∫ËØçÔºåÁ°Æ‰øùÊØèË°åÈÉΩÂ∑¶ÂØπÈΩê
        const defaultPrompt = `Âè™Á≤æÁÆÄÊÄªÁªì‰ª•‰∏ãÂÜÖÂÆπÁöÑÊ†∏ÂøÉË¶ÅÁÇπ„ÄÅ‰∏çÈúÄË¶ÅÂä†ÂÖ•‰Ω†ÁöÑ‰ªª‰ΩïËßÇÁÇπ`;

        // Âä†ËΩΩÂ∑≤‰øùÂ≠òÁöÑËÆæÁΩÆ
        const loadSettings = () => {
            const settings = JSON.parse(localStorage.getItem('v2exSummarySettings') || '{}');
            document.getElementById('apiUrl').value = settings.apiUrl || '';
            document.getElementById('apiKey').value = settings.apiKey || '';
            document.getElementById('modelName').value = settings.modelName || '';
            document.getElementById('prompt').value = settings.prompt || defaultPrompt;  // ‰ΩøÁî®ÈªòËÆ§ÊèêÁ§∫ËØç
        };

        // ‰øùÂ≠òËÆæÁΩÆ
        const saveSettings = () => {
            const settings = {
                apiUrl: document.getElementById('apiUrl').value,
                apiKey: document.getElementById('apiKey').value,
                modelName: document.getElementById('modelName').value,
                prompt: document.getElementById('prompt').value
            };
            localStorage.setItem('v2exSummarySettings', JSON.stringify(settings));
            modal.remove();
        };

        // Ê∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨
        modal.querySelector('#saveBtn').addEventListener('click', saveSettings);
        modal.querySelector('#cancelBtn').addEventListener('click', () => modal.remove());

        // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });

        // ÊòæÁ§∫Ê®°ÊÄÅÊ°ÜÂπ∂Âä†ËΩΩËÆæÁΩÆ
        document.body.appendChild(modal);
        loadSettings();
    }

    function addSummaryButton() {
        const header = document.querySelector('.header');
        if (header) {
            const grayDiv = header.querySelector('.gray');
            if (grayDiv && !grayDiv.querySelector('.summary-button')) {
                // Ê∑ªÂä†ÊÄªÁªìÊåâÈíÆ
                grayDiv.insertAdjacentText('beforeend', ' ‚àô ');
                
                // ÂàõÂª∫ÊÄªÁªìÊåâÈíÆ
                const summaryButton = document.createElement('a');
                summaryButton.href = 'javascript:void(0);';
                summaryButton.className = 'tb summary-button';
                summaryButton.innerHTML = 'ÊÄªÁªì <span style="font-size: 14px;">‚ú®</span>';
                
                // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
                summaryButton.addEventListener('click', async () => {
                    const content = getTopicContent();
                    if (content) {
                        const summaryContainer = addSummaryContainer();
                        if (summaryContainer) {
                            const summaryContent = summaryContainer.querySelector('.summary-content');
                            const topicId = getTopicId();
                            
                            // Ê£ÄÊü•ÊòØÂê¶Êúâ‰øùÂ≠òÁöÑÊÄªÁªì
                            const savedSummary = getSavedSummary(topicId);
                            if (savedSummary) {
                                // Â¶ÇÊûúÊúâ‰øùÂ≠òÁöÑÊÄªÁªìÔºåÁõ¥Êé•ÊòæÁ§∫
                                summaryContent.innerHTML = savedSummary;
                                summaryContainer.style.display = 'block';
                            } else {
                                // Â¶ÇÊûúÊ≤°Êúâ‰øùÂ≠òÁöÑÊÄªÁªìÔºåÂèëËµ∑Êñ∞ËØ∑Ê±Ç
                                summaryContent.textContent = 'Ê≠£Âú®ÁîüÊàêÊÄªÁªì...';
                                summaryContainer.style.display = 'block';

                                const summary = await sendSummaryRequest(content);
                                if (summary) {
                                    // ‰øùÂ≠òÂπ∂ÊòæÁ§∫Êñ∞ÁöÑÊÄªÁªì
                                    saveSummary(topicId, summary);
                                    summaryContent.innerHTML = summary;
                                } else {
                                    summaryContent.textContent = 'ÁîüÊàêÊÄªÁªìÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ËÆæÁΩÆÂíåÁΩëÁªúËøûÊé•';
                                }
                            }
                        }
                    }
                });

                grayDiv.appendChild(summaryButton);

                // Ê∑ªÂä†ÈöîÁ¨¶ÂíåËÆæÁΩÆÊåâÈíÆ
                grayDiv.insertAdjacentText('beforeend', ' ‚àô ');
                
                // ÂàõÂª∫ËÆæÁΩÆÊåâÈíÆ
                const settingsButton = document.createElement('a');
                settingsButton.href = 'javascript:void(0);';
                settingsButton.className = 'tb settings-button';
                settingsButton.innerHTML = 'ËÆæÁΩÆ <span style="font-size: 14px;">‚öôÔ∏è</span>';
                
                // Ê∑ªÂä†ËÆæÁΩÆÊåâÈíÆÁöÑÁÇπÂáª‰∫ã‰ª∂
                settingsButton.addEventListener('click', () => {
                    createSettingsModal();
                });

                grayDiv.appendChild(settingsButton);
            }
        }
    }

    function getTopicId() {
        const match = window.location.pathname.match(/\/t\/(\d+)/);
        return match ? match[1] : null;
    }

    function convertToMarkdown(element) {
        // Âª∫Ê∑±Â∫¶ÂÖãÈöÜ‰ª•ÈÅøÂÖç‰øÆÊîπÂéüÂßãDOM
        const clone = element.cloneNode(true);
        
        // Â§ÑÁêÜÊ†áÈ¢ò
        clone.querySelectorAll('h1,h2,h3,h4,h5,h6').forEach(header => {
            const level = header.tagName.charAt(1);
            const text = header.textContent.trim();
            header.outerHTML = `\n${'#'.repeat(level)} ${text}\n\n`;
        });

        // Â§ÑÁêÜÂõæÁâá
        clone.querySelectorAll('img').forEach(img => {
            const src = img.getAttribute('src');
            const alt = img.getAttribute('alt') || '';
            img.outerHTML = `\n![${alt}](${src})\n\n`;
        });

        // Â§ÑÁêÜËßÜÈ¢ë
        clone.querySelectorAll('video').forEach(video => {
            const src = video.getAttribute('src') || video.querySelector('source')?.getAttribute('src');
            if (src) {
                video.outerHTML = `\n[ËßÜÈ¢ëÈìæÊé•](${src})\n\n`;
            }
        });

        // Â§ÑÁêÜÈìæÊé•
        clone.querySelectorAll('a').forEach(link => {
            const href = link.getAttribute('href');
            const text = link.textContent.trim();
            if (href && text) {
                link.outerHTML = `[${text}](${href})`;
            }
        });

        // Â§ÑÁêÜ‰ª£Á†ÅÂùó
        clone.querySelectorAll('pre').forEach(pre => {
            const code = pre.textContent.trim();
            pre.outerHTML = `\n\`\`\`\n${code}\n\`\`\`\n\n`;
        });

        // Â§ÑÁêÜË°åÂÜÖ‰ª£Á†Å
        clone.querySelectorAll('code:not(pre code)').forEach(code => {
            const text = code.textContent.trim();
            code.outerHTML = `\`${text}\``;
        });

        // Â§ÑÁêÜÁ≤ó‰Ωì
        clone.querySelectorAll('strong,b').forEach(bold => {
            const text = bold.textContent.trim();
            bold.outerHTML = `**${text}**`;
        });

        // Â§ÑÁêÜÊñú‰Ωì
        clone.querySelectorAll('em,i').forEach(italic => {
            const text = italic.textContent.trim();
            italic.outerHTML = `*${text}*`;
        });

        // Â§ÑÁêÜÂàóË°®
        clone.querySelectorAll('ul,ol').forEach(list => {
            const items = Array.from(list.querySelectorAll('li')).map(li => {
                const text = li.textContent.trim();
                return list.tagName.toLowerCase() === 'ul' ? 
                    `- ${text}` : 
                    `1. ${text}`;
            });
            list.outerHTML = `\n${items.join('\n')}\n\n`;
        });

        // Â§ÑÁêÜÊÆµËêΩ
        clone.querySelectorAll('p').forEach(p => {
            const text = p.innerHTML.trim();
            p.outerHTML = `\n${text}\n\n`;
        });

        // Ëé∑ÂèñÂ§ÑÁêÜÂêéÁöÑÂÜÖÂÆπ
        let content = clone.innerHTML
            // Â§ÑÁêÜÊç¢Ë°å
            .replace(/<br\s*\/?>/gi, '\n')
            // ÁßªÈô§Ââ©‰ΩôÁöÑHTMLÊ†áÁ≠æ
            .replace(/<[^>]+>/g, '')
            // Â§ÑÁêÜHTMLÂÆû‰Ωì
            .replace(/&nbsp;/g, ' ')
            .replace(/&lt;/g, '<')
            .replace(/&gt;/g, '>')
            .replace(/&amp;/g, '&')
            .replace(/&quot;/g, '"')
            // Ê∏ÖÁêÜÂ§ö‰ΩôÁ©∫Ë°åÂíåÁ©∫Ê†º
            .replace(/\n\s*\n\s*\n/g, '\n\n')
            .replace(/[ \t]+\n/g, '\n')
            .trim();

        // Á°Æ‰øùÊÆµËêΩ‰πãÈó¥ÊúâÁ©∫Ë°å
        content = content
            .split('\n')
            .map(line => line.trim())
            .filter(line => line)
            .join('\n\n');

        return content;
    }

    function getTopicContent() {
        const contentDiv = document.querySelector('.topic_content');
        if (contentDiv) {
            return convertToMarkdown(contentDiv);
        }
        return null;
    }

    function init() {
        const topicId = getTopicId();
        if (topicId) {
            addSummaryButton();
        }
    }

    // Á≠âÂæÖÈ°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÊâßË°å
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }

    // Ê∑ªÂä†ÂèñÂíå‰øùÂ≠òÊÄªÁªìÁöÑÂáΩÊï∞
    function getSavedSummary(topicId) {
        const summaries = JSON.parse(localStorage.getItem('v2exArticleSummaries') || '{}');
        return summaries[topicId];
    }

    function saveSummary(topicId, summary) {
        const summaries = JSON.parse(localStorage.getItem('v2exArticleSummaries') || '{}');
        summaries[topicId] = summary;
        localStorage.setItem('v2exArticleSummaries', JSON.stringify(summaries));
    }

    // ‰øÆÊîπÊÄªÁªìÂÆπÂô®ÔºåÊ∑ªÂä†ÈáçÊñ∞ÁîüÊàêÊåâÈíÆ
    function addSummaryContainer() {
        const header = document.querySelector('.header');
        if (header && !document.querySelector('.summary-container')) {
            // ÂàõÂª∫ÊÄªÁªìÂÜÖÂÆπÂÆπÂô®
            const summaryContainer = document.createElement('div');
            summaryContainer.className = 'summary-container';
            summaryContainer.style.cssText = `
                margin: 10px 0;
                padding: 15px;
                background: var(--box-background-color, #fff);
                border-radius: 6px;
                font-size: 14px;
                line-height: 1.6;
                display: none;
                border: 1px solid var(--box-border-color, #eee);
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            `;

            // Ê∑ªÂä†Ê†áÈ¢òÊ†è
            const titleBar = document.createElement('div');
            titleBar.style.cssText = `
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
                padding-bottom: 8px;
                border-bottom: 1px solid var(--box-border-color, #eee);
            `;
            
            const titleLeft = document.createElement('div');
            titleLeft.style.cssText = `
                display: flex;
                align-items: center;
                gap: 10px;
            `;
            
            const title = document.createElement('div');
            title.innerHTML = 'üìù ÊñáÁ´†ÊÄªÁªì';
            title.style.fontWeight = '500';
            
            const regenerateButton = document.createElement('a');
            regenerateButton.innerHTML = 'üîÑ ÈáçÊñ∞ÁîüÊàê';
            regenerateButton.href = 'javascript:void(0);';
            regenerateButton.className = 'tb';
            regenerateButton.style.fontSize = '12px';
            regenerateButton.addEventListener('click', async () => {
                const content = getTopicContent();
                if (content) {
                    const summaryContent = document.querySelector('.summary-content');
                    summaryContent.textContent = 'Ê≠£Âú®ÈáçÊñ∞ÁîüÊàêÊÄªÁªì...';
                    
                    const summary = await sendSummaryRequest(content);
                    if (summary) {
                        const topicId = getTopicId();
                        saveSummary(topicId, summary);
                        summaryContent.innerHTML = summary;
                    } else {
                        summaryContent.textContent = 'ÁîüÊàêÊÄªÁªìÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ËÆæÁΩÆÂíåÁΩëÁªúËøûÊé•';
                    }
                }
            });

            titleLeft.appendChild(title);
            titleLeft.appendChild(regenerateButton);
            
            const closeButton = document.createElement('span');
            closeButton.innerHTML = '‚úï';
            closeButton.style.cssText = `
                cursor: pointer;
                opacity: 0.6;
                font-size: 16px;
                padding: 4px 8px;
            `;
            closeButton.addEventListener('click', () => {
                summaryContainer.style.display = 'none';
            });

            titleBar.appendChild(titleLeft);
            titleBar.appendChild(closeButton);
            summaryContainer.appendChild(titleBar);

            // Ê∑ªÂä†ÂÜÖÂÆπÂå∫
            const content = document.createElement('div');
            content.className = 'summary-content';
            content.style.cssText = `
                white-space: pre-wrap;
                word-break: break-word;
                text-align: left;
                padding: 10px 0;
                line-height: 1.8;
            `;
            summaryContainer.appendChild(content);

            // ‰øÆÊîπÊèíÂÖ•‰ΩçÁΩÆÔºöÂú® header ÂêéÈù¢ÊèíÂÖ•
            header.parentNode.insertBefore(summaryContainer, header.nextSibling);

            return summaryContainer;
        }
        return document.querySelector('.summary-container');
    }

    // Ê∑ªÂä†ÂèëÈÄÅËØ∑Ê±ÇÁöÑÂáΩÊï∞
    async function sendSummaryRequest(content) {
        // Ëé∑ÂèñËÆæÁΩÆ
        const settings = JSON.parse(localStorage.getItem('v2exSummarySettings') || '{}');
        
        // Ê£ÄÊü•ÂøÖË¶ÅÁöÑËÆæÁΩÆÊòØÂê¶Â≠òÂú®
        if (!settings.apiUrl || !settings.apiKey || !settings.modelName) {
            alert('ËØ∑ÂÖàÂÆåÊàêËÆæÁΩÆÔºàAPI URL„ÄÅAPI Key ÂíåÊ®°ÂûãÂêçÁß∞‰∏∫ÂøÖÂ°´È°πÔºâ');
            return null;
        }

        try {
            const response = await fetch(settings.apiUrl, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${settings.apiKey}`,
                    'Content-Type': 'application/json',
                    'Accept': '*/*',
                    'Connection': 'keep-alive'
                },
                body: JSON.stringify({
                    messages: [
                        {
                            role: "system",
                            content: settings.prompt || defaultPrompt
                        },
                        {
                            role: "user",
                            content: content
                        }
                    ],
                    model: settings.modelName,
                    stream: false
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            return data.choices?.[0]?.message?.content || 'ÊÄªÁªìÁîüÊàêÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•APIËøîÂõûÊ†ºÂºè';

        } catch (error) {
            alert(`ËØ∑Ê±ÇÂ§±Ë¥•: ${error.message}`);
            return null;
        }
    }
})(); 